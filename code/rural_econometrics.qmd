---
title: "Establishing Indicators of Firm Failures for Texas Rural Towns: Exploring Machine Learning Models"
author: "Reece Iriye"
format: 
  html:
    link-citations: true
    toc: true
    embed-resources: true
    code-fold: true
    code-line-numbers: true
    code-summary: "SHOW ME THE CODE!"
    code-tools: false
    theme: zephyr
editor: visual
---

## Abstract

## Introduction

```{r}
#| echo: false
#| message: false
#| warning: false
library(lubridate)
library(tidyverse)
library(tidymodels)
library(ggplot2)
library(plotly)
```

## Feature Selection

### New Firms
```{r}
#| message: false
#| warning: false
#| freeze: true

# Read in new firm data (Data last updated 03/22/2023)
new.firms <- read.csv("/Users/reece/Desktop/plsc3320/theory_data/Active_Franchise_Tax_Permit_Holders.csv")

# Remove irrelevant columns and ensure we are only evaluating Texas
new.firms.diminished <- new.firms %>%
  select(Taxpayer.Number, Taxpayer.Name, Taxpayer.City, Taxpayer.State, Taxpayer.County.Code, Responsibility.Beginning.Date) %>%
  filter(Taxpayer.State == "TX")

# Convert dates column to datetime type
new.firms.diminished$Responsibility.Beginning.Date <- mdy(new.firms.diminished$Responsibility.Beginning.Date)
  
# Order data by year
new.firms.ordered <- new.firms.diminished %>%
  arrange(Responsibility.Beginning.Date) %>%
  mutate(Responsibility.Year = year(Responsibility.Beginning.Date))

# Filter to 2000-2019
new.firms.ordered2 <- new.firms.ordered %>%
  filter(Responsibility.Year >= 2000 & !(Responsibility.Year %in% c(2020, 2023))) %>%
  mutate(MonthDate = month(Responsibility.Beginning.Date)) %>%
  mutate(months = factor(month.abb[MonthDate], levels = month.abb)) %>%
  mutate(Day = day(Responsibility.Beginning.Date))

# Remove January [see "Data Characteristics" tab for justification]
new.firms.ordered3 <- new.firms.ordered2 %>%
  filter(MonthDate != 1 & Day != 1)

# Total new firms
total.new.firms <- new.firms.ordered3 %>%
  group_by(Responsibility.Year, Taxpayer.City) %>%
  summarize(firms.established = n())

```

## Data Characteristics

### Potential Date Error in Texas Comptroller Data

```{r}
#| message: false
#| warning: false
#| freeze: true

# Generate histogram of Dates to justify elimination of January data
ggplot(new.firms.ordered2, aes(x=months)) +
  geom_bar(color="black") +
  labs(x="Month", y="Monthly Tax Payment Frequency") +
  ggtitle("Monthly Frequency of Texas Franchise Tax Payments",
          subtitle = "Evaluation of Franchise Tax Payment Data from the Texas Comptroller's Office") +
  theme_bw() +
  scale_y_continuous(labels = label_comma())

```

The frequency of each month is largely uniform, except for January which sees an abnormally high frequency almost twice as large as the other predictors. Examining the dataset, I noticed that a large amount of payment dates recorded by the Texas Comptroller's Office were on January 1 of a chosen year. 


It is unlikely that so many businesses would pay their franchise tax on January 1st in each year from 2000-2022. It could be possible that Jan 1 is being used as the default date selection when an actual day is not noticed, or it could be data from the previous year that is logged late. This heavy emphasis on January 1 could likely suggest an error in date reporting. To minimize potential sources of bias or error in my analysis, I will be omitting January 1 as an establishment date for my overall dataset. We do not know the the exact source of this issue, which is why pursuing this avenue is the safest direction to pursue in minimizing the error in my overall model. 

Omitting Jan 1, here is an updated distribution of dates:

```{r}
#| message: false
#| warning: false
#| freeze: true

# Generate histogram of Dates to justify elimination of January data
ggplot(new.firms.ordered3, aes(x=months)) +
  geom_bar(color="black") +
  labs(x="Month", y="Monthly Tax Payment Frequency") +
  ggtitle("Monthly Frequency of Texas Franchise Tax Payments",
          subtitle = "Evaluation of Franchise Tax Payment Data from the Texas Comptroller's Office") +
  theme_bw() +
  scale_y_continuous(labels = label_comma())

```

### Total New Firms by Year

## Implementing Machine Learning Algorithms

## Findings

## Drawing Inferences from Findings

## Conclusion
